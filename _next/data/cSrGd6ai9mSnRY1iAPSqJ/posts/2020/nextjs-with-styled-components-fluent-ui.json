{"pageProps":{"id":["2020","nextjs-with-styled-components-fluent-ui"],"name":"nextjs-with-styled-components-fluent-ui","data":{"date":"2020-09-03","weather":"晴","body":"昨晚发现，初始化和切换菜单时，ui 会抖动，以为是组件切换时布局不合理导致的，后来突然想到初始化和`a`标签跳转时应该用的服务端渲染，此时页面结构和样式文件几乎同时渲染，不应该抖动。\n\n后来想到只给`styled-components`做了`ssr`处理，`@fluent-ui`的样式依然是后加载的，检查了页面的 response，果然这样。\n\nnextjs 官方仓库有对`styled-components`做`ssr`的示例，也找到了`@fluent-ui`官方的[做法](https://github.com/microsoft/fluentui/wiki/Server-side-rendering-and-browserless-testing#nextjs-setup)，但是没有两者结合在一起的。\n\n后来研究发现，`styled-components`的`ssr`处理是返回了一个 react 组件，而`@fluent-ui`返回一段 css 代码。这样，前者按 react 组件渲染，后者写入到 style 标签里，再结合到一个父组件内，放到页面 head 部分，就可以实现对两者样式的共同渲染。\n\n完整代码如下：\n\n```js\nimport Document, { DocumentContext } from 'next/document'\nimport { ServerStyleSheet } from 'styled-components'\nimport { Stylesheet, InjectionMode } from '@uifabric/merge-styles'\nimport { resetIds } from '@uifabric/utilities'\n\n// Do this in file scope to initialize the stylesheet before Fabric components are imported.\nconst stylesheet = Stylesheet.getInstance()\n\n// Set the config.\nstylesheet.setConfig({\n  injectionMode: InjectionMode.none,\n  namespace: 'server',\n})\n\nexport default class MyDocument extends Document {\n  static async getInitialProps(ctx: DocumentContext) {\n    stylesheet.reset()\n    resetIds()\n\n    const sheet = new ServerStyleSheet()\n    const originalRenderPage = ctx.renderPage\n\n    try {\n      ctx.renderPage = () =>\n        originalRenderPage({\n          enhanceApp: (App) => (props) => sheet.collectStyles(<App {...props} />),\n        })\n\n      const initialProps = await Document.getInitialProps(ctx)\n      const styleTags = stylesheet.getRules(true)\n\n      return {\n        ...initialProps,\n        styles: (\n          <>\n            {initialProps.styles}\n            <style type=\"text/css\" dangerouslySetInnerHTML={{ __html: styleTags }} />\n            {sheet.getStyleElement()}\n          </>\n        ),\n      }\n    } finally {\n      sheet.seal()\n    }\n  }\n}\n```"},"allPosts":[{"date":"2021","list":[{"name":"绩效约谈后有感","date":"2021-02-24","path":"ji-xiao-yue-tan-hou-you-gan","groupDate":"2021"},{"name":"面对人生选择","date":"2021-02-20","path":"mian-dui-ren-sheng-xuan-ze","groupDate":"2021"},{"name":"我的生日","date":"2021-01-27","path":"wo-de-sheng-ri","groupDate":"2021"},{"name":"2021年初的一点思考","date":"2021-01-20","path":"2021-nian-chu-de-yi-dian-si-kao","groupDate":"2021"}]},{"date":"2020","list":[{"name":"win10下使用wls2和vscode配置超级舒服的开发环境 ","date":"2020-11-29","path":"win10-xia-shi-yong-wls2-he-vscode-pei-zhi-chao-ji-shu-fu-de-kai-fa-huan-jing","groupDate":"2020"},{"name":"Termux玩法","date":"2020-10-19","path":"Termux-wan-fa","groupDate":"2020"},{"name":"nextjs-with-styled-components-fluent-ui","date":"2020-09-03","path":"nextjs-with-styled-components-fluent-ui","groupDate":"2020"},{"name":"脂肪肝","date":"2020-08-30","path":"zhi-fang-gan","groupDate":"2020"}]},{"date":"2018","list":[{"name":"两个口袋","date":"2018-05-06","path":"liang-ge-kou-dai","groupDate":"2018"}]},{"date":"2017","list":[{"name":"JavaScript50行代码暴力生成9x9数独","date":"2017-10-12","path":"JavaScript50-hang-dai-ma-bao-li-sheng-cheng-9x9-shu-du","groupDate":"2017"},{"name":"域名解析小记","date":"2017-09-23","path":"yu-ming-jie-xi-xiao-ji","groupDate":"2017"},{"name":"nginx作用","date":"2017-09-23","path":"nginx-zuo-yong","groupDate":"2017"},{"name":"linux nginx配置https笔记","date":"2017-09-23","path":"linux-nginx-pei-zhi-https-bi-ji","groupDate":"2017"},{"name":"React Material-UI笔记-theme篇","date":"2017-09-20","path":"React-Material-UI-bi-ji--theme-pian","groupDate":"2017"},{"name":"js异步之callback简述","date":"2017-07-07","path":"js-yi-bu-zhi-callback-jian-shu","groupDate":"2017"},{"name":"python爬虫初体验","date":"2017-06-03","path":"python-pa-chong-chu-ti-yan","groupDate":"2017"},{"name":"redux-saga简单入门使用","date":"2017-05-08","path":"redux-saga-jian-dan-ru-men-shi-yong","groupDate":"2017"},{"name":"react-native触摸和动画实例","date":"2017-05-06","path":"react-native-chu-mo-he-dong-hua-shi-li","groupDate":"2017"},{"name":"react技术栈学习","date":"2017-02-27","path":"react-ji-shu-zhan-xue-xi","groupDate":"2017"},{"name":"es6 export和import相关","date":"2017-02-26","path":"es6-export-he-import-xiang-guan","groupDate":"2017"},{"name":"canvas交互之addHitRegion()接口的使用","date":"2017-02-16","path":"canvas-jiao-hu-zhi-addHitRegion()-jie-kou-de-shi-yong","groupDate":"2017"}]},{"date":"2015","list":[{"name":"学车随笔","date":"2015-08-21","path":"xue-che-sui-bi","groupDate":"2015"},{"name":"怀念我的部长-刘高","date":"2015-04-10","path":"huai-nian-wo-de-bu-chang---liu-gao","groupDate":"2015"}]}],"datePosts":[{"name":"win10下使用wls2和vscode配置超级舒服的开发环境 ","date":"2020-11-29","path":"win10-xia-shi-yong-wls2-he-vscode-pei-zhi-chao-ji-shu-fu-de-kai-fa-huan-jing"},{"name":"Termux玩法","date":"2020-10-19","path":"Termux-wan-fa"},{"name":"nextjs-with-styled-components-fluent-ui","date":"2020-09-03","path":"nextjs-with-styled-components-fluent-ui"},{"name":"脂肪肝","date":"2020-08-30","path":"zhi-fang-gan"}]},"__N_SSG":true}